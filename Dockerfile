# -----------------------------------------------------------
# Stage 1: ビルド環境 (アプリケーションのコンパイル)
# -----------------------------------------------------------
# MavenとJava 21がインストールされた公式イメージを使用
FROM maven:3.9.6-eclipse-temurin-21 AS builder

# コンテナ内の作業ディレクトリを /app に設定
WORKDIR /app

# Mavenの依存関係ファイルをコピー（依存関係の変更がなければ、キャッシュが効いて高速化される）
COPY pom.xml .

# アプリケーションのソースコードをコピー
COPY src ./src

# Mavenでアプリケーションをビルド。テストはスキップ。
RUN mvn clean package -DskipTests

# -----------------------------------------------------------
# Stage 2: 実行環境 (アプリケーションの実行)
# -----------------------------------------------------------
# 軽量なJava実行環境のイメージを使用
FROM eclipse-temurin:21-jre 

# コンテナ内の作業ディレクトリを /app に設定
WORKDIR /app

# ビルドステージ（Stage 1）で作成されたJARファイルをコピー
COPY --from=builder /app/target/*.jar app.jar

# アプリケーションを起動するためのコマンドを指定
ENTRYPOINT ["java", "-jar", "app.jar"]

# ポート8080を公開することを宣言（これはドキュメント的な意味）
EXPOSE 8080